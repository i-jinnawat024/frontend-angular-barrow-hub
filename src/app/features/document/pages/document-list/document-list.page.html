<div class="container-fluid mx-auto px-4 py-8">
  <!-- Header -->
  <div class="mb-4 flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-primary">เล่มทะเบียน</h1>
      <p class="mt-2 text-secondary">จัดการรายการเล่มทะเบียนทั้งหมดในระบบ</p>
    </div>
    <div class="flex items-center gap-2">
      <button
        type="button"
        class="btn-primary cursor-pointer"
        mat-button
        (click)="createDocument()"
      >
        <mat-icon style="font-size: 18px; width: 18px; height: 18px">add</mat-icon>
        @if (this.isDesktopView()) {
          <span style="margin-left: 4px">เพิ่มเล่มทะเบียน</span>
        }
      </button>
      <a
        class="btn-secondary inline-flex items-center gap-1 cursor-pointer"
        mat-button
       (click)="exportToExcel()"
      >
        <mat-icon style="font-size: 18px; width: 18px; height: 18px">download</mat-icon>
        @if (this.isDesktopView()) {
          <span>ดาวน์โหลด Template</span>
        }
      </a>
      <button
        type="button"
        class="btn-secondary inline-flex items-center gap-1 cursor-pointer"
        mat-button
        (click)="openImportDialog()"
      >
        <mat-icon style="font-size: 18px; width: 18px; height: 18px">upload_file</mat-icon>
        @if (this.isDesktopView()) {
          <span>นำเข้าจากไฟล์</span>
        }
      </button>
      <input
        #registryImportInput
        type="file"
        accept=".xlsx,.csv"
        class="hidden"
        (change)="onImportFileSelected($event)"
      />
    </div>
  </div>

  @if (hasImportPreview() || hasImportErrors() || isImporting()) {
    <div class="mb-6 rounded-lg border border-dashed border-primary bg-surface-alt px-6 py-5">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-lg font-semibold text-primary">ตรวจสอบข้อมูลก่อนนำเข้า</h2>
          <p class="text-sm text-secondary">
            ไฟล์: {{ importFileName() ?? 'ไม่ได้เลือกไฟล์' }}
          </p>
        </div>
        @if (hasImportPreview()) {
          <div class="text-sm text-secondary">
            พร้อมนำเข้า {{ importPreview().length }} รายการ
          </div>
        }
      </div>

      @if (isImporting()) {
        <p class="mt-4 text-sm text-secondary">กำลังอ่านไฟล์ กรุณารอสักครู่...</p>
      } @else {
        @if (hasImportErrors()) {
          <div class="mt-4 alert-warning rounded-md px-4 py-3 text-sm">
            <p class="font-medium">พบข้อผิดพลาดในไฟล์นำเข้า</p>
            <ul class="mt-2 list-disc space-y-1 ps-5">
              @for (error of importErrors(); track error) {
                <li>{{ error }}</li>
              }
            </ul>
          </div>
        }

        @if (hasImportPreview()) {
          <div class="mt-4 overflow-x-auto">
            <table class="min-w-full divide-y divide-subtle text-left text-sm">
              <thead class="bg-table-header text-xs uppercase text-secondary">
                <tr>
                  <th class="px-4 py-2">แถวที่</th>
                  <th class="px-4 py-2">เลขเล่มทะเบียน</th>
                  <th class="px-4 py-2">ชื่อ</th>
                  <th class="px-4 py-2">นามสกุล</th>
                  <th class="px-4 py-2">สถานะ</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-subtle bg-surface text-secondary">
                @for (preview of importPreviewSample(); track preview.rowNumber) {
                  <tr>
                    <td class="px-4 py-2">{{ preview.rowNumber - 1}}</td>
                    <td class="px-4 py-2 font-medium text-primary">{{ preview.documentId }}</td>
                    <td class="px-4 py-2">{{ preview.firstName }}</td>
                    <td class="px-4 py-2">{{ preview.lastName }}</td>
                    <td class="px-4 py-2">
                      @switch (preview.status) {
                        @case ('ACTIVE') { พร้อมใช้งาน }
                        @case ('BORROWED') { กำลังยืม }
                        @case ('ARCHIVED') { เก็บถาวร }
                        @case ('INACTIVE') { ปิดใช้งาน }
                        @default { - }
                      }
                    </td>
                  </tr>
                }
              </tbody>
            </table>
            @if (importPreviewRemaining() > 0) {
              <p class="mt-2 text-xs text-secondary">
                แสดงตัวอย่าง {{ importPreviewSample().length }} รายการแรก และมีอีก
                {{ importPreviewRemaining() }} รายการรอนำเข้า
              </p>
            }
          </div>

          <div class="mt-4 flex flex-col gap-2 text-sm text-secondary sm:flex-row sm:items-center sm:justify-between">
            <p>
              คอลัมน์ที่รองรับ: เลขเล่มทะเบียน, ชื่อเล่มทะเบียน, รายละเอียด (ถ้ามี), สถานะ (ถ้ามี) หรือดาวน์โหลดไฟล์ Template (.xlsx) เพื่ออ้างอิงรูปแบบ
            </p>
            <div class="flex gap-2">
              <button type="button" class="btn-secondary" (click)="cancelImportPreview()">
                ยกเลิก
              </button>
              <button type="button" class="btn-primary" (click)="confirmImportPreview()">
                ยืนยันการนำเข้า
              </button>
            </div>
          </div>
        } @else if (!hasImportErrors()) {
          <p class="mt-4 text-sm text-secondary">ยังไม่มีข้อมูลที่สามารถนำเข้าได้</p>
        }
      }
    </div>
  }

  <!-- Registry Books Table -->
  <div class="bg-surface rounded-lg shadow border border-subtle overflow-hidden mt-4">
       <div class="border-b border-subtle bg-surface-alt px-4 py-4">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="relative w-full sm:w-80">
          <div class="pointer-events-none absolute inset-y-0 start-0 flex items-center ps-3">
            <mat-icon class="text-secondary text-base">search</mat-icon>
          </div>
          <input
            type="search"
            class="form-control w-full ps-10 pe-10"
            placeholder="ค้นหาเล่มทะเบียน"
            autocomplete="off"
            [value]="searchTerm()"
            (input)="onSearchTermChange($event)"
          />
          @if (hasSearchTerm()) {
            <button
              type="button"
              class="table-search-clear"
              (click)="clearSearch()"
              aria-label="ล้างการค้นหา"
            >
              <mat-icon class="text-secondary text-base">close</mat-icon>
            </button>
          }
        </div>
      </div>
    </div>
    <div class="overflow-x-auto">
      @if (filteredRegistryBooks().length > 0) {
        <table class="w-full text-sm text-left rtl:text-right text-secondary">
          <thead class="bg-table-header text-xs uppercase text-secondary">
            <tr>
              @for (column of columns; track column.property) {
                <th scope="col" class="px-6 py-3">
                  @if (column.sortable) {
                    <button
                      type="button"
                      class="table-sort-button"
                      (click)="toggleSort(column.property)"
                      [attr.aria-sort]="
                        isSortedAscending(column.property)
                          ? 'ascending'
                          : isSortedDescending(column.property)
                          ? 'descending'
                          : 'none'
                      "
                    >
                      <span>{{ column.label }}</span>
                      <mat-icon class="table-sort-icon">
                        @if (isSortedAscending(column.property)) {
                          arrow_upward
                        } @else if (isSortedDescending(column.property)) {
                          arrow_downward
                        } @else {
                          unfold_more
                        }
                      </mat-icon>
                    </button>
                  } @else {
                    <span class="table-header-label">{{ column.label }}</span>
                  }
                </th>
              }
            </tr>
          </thead>
          <tbody>
            @for (book of filteredRegistryBooks(); track book.id) {
              <tr class="bg-surface transition hover:bg-surface-hover">
                <th scope="row" class="px-6 py-4 font-medium text-secondary">
                  {{ book.documentId }}
                </th>
                <td class="px-6 py-4">
                  {{ book.firstName }} {{book.lastName}}
                </td>
                <td class="px-6 py-4">
                  @switch (book.status) {
                    @case ('ACTIVE') {
                      <span class="badge badge-success"> พร้อมใช้งาน </span>
                    }
                    @case ('BORROWED') {
                      <span class="badge badge-warning"> กำลังยืม </span>
                    }
                    @case ('ARCHIVED') {
                      <span class="badge badge-neutral"> เก็บถาวร </span>
                    }
                    @case ('INACTIVE') {
                    <span class="badge badge-alert" style="background-color: #dc3545; color: white"> ปิดใช้งาน </span>
                    }
                    @default {
                      <span class="badge badge-alert" style="background-color: #dc3545; color: white">
                        ไม่ทราบสถานะ
                      </span>
                    }
                  }
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                  <div class="flex items-center gap-2">
                    <button
                      type="button"
                      class="text-link hover:text-link-strong cursor-pointer"
                      (click)="viewDetails(book.id)"
                      title="ดูรายละเอียด"
                    >
                      <mat-icon
                        class="material-symbols-outlined"
                        style="font-size: 20px; width: 18px; height: 18px"
                      >
                        visibility
                      </mat-icon>
                    </button>
                    <button
                      type="button"
                      class="text-success hover:text-success-strong cursor-pointer"
                      (click)="editDocument(book.id)"
                      title="แก้ไข"
                    >
                      <mat-icon
                        class="material-symbols-outlined"
                        style="font-size: 20px; width: 18px; height: 18px"
                      >
                        edit_document
                      </mat-icon>
                    </button>
                    <!-- <button
                      type="button"
                      class="text-danger hover:text-danger-strong cursor-pointer"
                      (click)="deleteRegistryBook(book.id)"
                      title="ลบ"
                    >
                      <mat-icon
                        class="material-symbols-outlined"
                        style="font-size: 20px; width: 18px; height: 18px"
                      >
                        delete
                      </mat-icon>
                    </button> -->
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      } @else if (registryBookCount() === 0 && !hasSearchTerm()) {
        <div class="p-12 text-center">
          <svg
            class="mx-auto h-12 w-12 text-muted"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
            ></path>
          </svg>
          <h3 class="mt-2 text-sm font-medium text-primary">ยังไม่มีเล่มทะเบียน</h3>
          <p class="mt-1 text-sm text-muted">เพิ่มเล่มทะเบียนแรกเพื่อเริ่มจัดการข้อมูล</p>
        </div>
      } @else {
        <div class="p-12 text-center">
          <mat-icon class="material-symbols-outlined text-muted" style="font-size: 48px">
            search_off
          </mat-icon>
          <h3 class="mt-2 text-sm font-medium text-primary">ไม่พบรายการที่ค้นหา</h3>
          <p class="mt-1 text-sm text-muted">กรุณาปรับคำค้นหรือเงื่อนไขแล้วลองอีกครั้ง</p>
        </div>
      }
    </div>
  </div>
</div>
